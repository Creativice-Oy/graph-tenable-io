import { Dictionary } from "../tenable/types";
import { createScanVulnerabilityRelationships } from "./ScanVulnerabilityRelationshipConverter";

const vulnerabilitiesDictionary: Dictionary<any[]> = {
  "dualbootpartners.com": [
    {
      scan_id: "TestId",
      host_id: 1,
      hostname: "dualbootpartners.com",
      plugin_id: 112526,
      plugin_name: "Missing 'X-XSS-Protection' Header",
      plugin_family: "Web Applications",
      count: 1,
      severity_index: 0,
      severity: 1,
    },
    {
      scan_id: "TestId",
      vuln_index: 1,
      host_id: 1,
      hostname: "dualbootpartners.com",
      plugin_id: 112530,
      plugin_name: "SSL/TLS Versions Supported",
      plugin_family: "Web Servers",
      count: 1,
      severity_index: 1,
      severity: 0,
    },
    {
      scan_id: "TestId",
      vuln_index: 2,
      host_id: 1,
      hostname: "dualbootpartners.com",
      plugin_id: 115491,
      plugin_name: "SSL/TLS Cipher Suites Supported",
      plugin_family: "Web Servers",
      count: 1,
      severity_index: 2,
      severity: 0,
    },
    {
      scan_id: "TestId",
      vuln_index: 3,
      host_id: 1,
      hostname: "dualbootpartners.com",
      plugin_id: 98138,
      plugin_name: "Screenshot",
      plugin_family: "General",
      count: 1,
      severity_index: 3,
      severity: 0,
    },
  ],
  "dualboot.ru": [
    {
      scan_id: "TestId2",
      vuln_index: 0,
      host_id: 2,
      hostname: "dualboot.ru",
      plugin_id: 98138,
      plugin_name: "Screenshot",
      plugin_family: "General",
      count: 1,
      severity_index: 0,
      severity: 0,
    },
    {
      scan_id: "TestId2",
      vuln_index: 1,
      host_id: 2,
      hostname: "dualboot.ru",
      plugin_id: 98000,
      plugin_name: "Scan Information",
      plugin_family: "General",
      count: 1,
      severity_index: 1,
      severity: 0,
    },
    {
      scan_id: "TestId2",
      vuln_index: 2,
      host_id: 2,
      hostname: "dualboot.ru",
      plugin_id: 98050,
      plugin_name: "Interesting response",
      plugin_family: "Web Applications",
      count: 3,
      severity_index: 2,
      severity: 0,
    },
  ],
};

const scans: any[] = [
  {
    id: "TestId",
    scanDetail: {
      info: {
        owner: "denis.arkhireev@dualbootpartners.com",
        name: ".com",
        no_target: false,
        folder_id: 8,
        control: true,
        user_permissions: 128,
        schedule_uuid:
          "template-2a48d3bb-1cd9-28a1-7742-c26c40ac09f7591cd108d64699c9",
        edit_allowed: false,
        scanner_name: "US Cloud Scanner",
        policy: "Web App Scan",
        shared: null,
        object_id: 12,
        hostcount: 0,
        uuid: "32c22094-3343-4163-a3ac-3863926b96e9",
        status: "completed",
        scan_type: "webapp",
        targets: "https://dualbootpartners.com",
        alt_targets_used: false,
        "pci-can-upload": false,
        timestamp: 1555068471,
        haskb: false,
        hasaudittrail: true,
      },
      hosts: [
        {
          host_index: 0,
          critical: 0,
          high: 0,
          medium: 4,
          low: 9,
          info: 12,
          severity: 25,
          host_id: 1,
          hostname: "dualbootpartners.com",
        },
      ],
      vulnerabilities: [
        {
          count: 1,
          plugin_family: "Web Applications",
          plugin_id: 112526,
          plugin_name: "Missing 'X-XSS-Protection' Header",
          severity: 1,
        },
        {
          count: 1,
          plugin_family: "Web Servers",
          plugin_id: 112530,
          plugin_name: "SSL/TLS Versions Supported",
          severity: 0,
        },
        {
          count: 1,
          plugin_family: "Web Servers",
          plugin_id: 115491,
          plugin_name: "SSL/TLS Cipher Suites Supported",
          severity: 0,
        },
        {
          count: 1,
          plugin_family: "General",
          plugin_id: 98138,
          plugin_name: "Screenshot",
          severity: 0,
        },
      ],
    },
  },
];

describe("convert assessment vulnerability relationships", () => {
  test("convert assessment vulnerability relationships", () => {
    const relationships = createScanVulnerabilityRelationships(
      scans,
      vulnerabilitiesDictionary,
    );
    expect(relationships).toEqual([
      {
        _class: "IDENTIFIED",
        _fromEntityKey: "tenable_scan_TestId",
        _key:
          "tenable_scan_TestId_identified_tenable_scan_vulnerability_112526_1_TestId",
        _toEntityKey: "tenable_scan_vulnerability_112526_1_TestId",
        _type: "tenable_scan_identified_tenable_scan_vulnerability",
      },
      {
        _class: "IDENTIFIED",
        _fromEntityKey: "tenable_scan_TestId",
        _key:
          "tenable_scan_TestId_identified_tenable_scan_vulnerability_112530_1_TestId",
        _toEntityKey: "tenable_scan_vulnerability_112530_1_TestId",
        _type: "tenable_scan_identified_tenable_scan_vulnerability",
      },
      {
        _class: "IDENTIFIED",
        _fromEntityKey: "tenable_scan_TestId",
        _key:
          "tenable_scan_TestId_identified_tenable_scan_vulnerability_115491_1_TestId",
        _toEntityKey: "tenable_scan_vulnerability_115491_1_TestId",
        _type: "tenable_scan_identified_tenable_scan_vulnerability",
      },
      {
        _class: "IDENTIFIED",
        _fromEntityKey: "tenable_scan_TestId",
        _key:
          "tenable_scan_TestId_identified_tenable_scan_vulnerability_98138_1_TestId",
        _toEntityKey: "tenable_scan_vulnerability_98138_1_TestId",
        _type: "tenable_scan_identified_tenable_scan_vulnerability",
      },
    ]);
  });
});
