import { Dictionary, ScanVulnerability } from "../tenable/types";
import { createVulnerabilityEntities } from "./ScanVulnerabilityEntityConverter";

test("one vulnerabilty per plugin_id", () => {
  const vulnerabilitiesDictionary: Dictionary<ScanVulnerability[]> = {
    "dualbootpartners.com": [
      {
        scan_id: 123,
        host_id: 1,
        hostname: "dualbootpartners.com",
        plugin_id: 112526,
        plugin_name: "Missing 'X-XSS-Protection' Header",
        plugin_family: "Web Applications",
        count: 1,
        severity: 1,
      },
      {
        scan_id: 456,
        host_id: 1,
        hostname: "dualbootpartners.com",
        plugin_id: 98138,
        plugin_name: "Screenshot",
        plugin_family: "General",
        count: 1,
        severity: 0,
      },
    ],
    "dualboot.ru": [
      {
        scan_id: 456,
        host_id: 2,
        hostname: "dualboot.ru",
        plugin_id: 98138,
        plugin_name: "Screenshot",
        plugin_family: "General",
        count: 1,
        severity: 0,
      },
    ],
  };

  const entities = createVulnerabilityEntities(vulnerabilitiesDictionary);

  expect(entities).toEqual([
    {
      _class: "Vulnerability",
      _key: "tenable_vulnerability_112526",
      _type: "tenable_vulnerability",
      pluginFamily: "Web Applications",
      pluginId: 112526,
      pluginName: "Missing 'X-XSS-Protection' Header",
      severity: 1,
    },
    {
      _class: "Vulnerability",
      _key: "tenable_vulnerability_98138",
      _type: "tenable_vulnerability",
      pluginFamily: "General",
      pluginId: 98138,
      pluginName: "Screenshot",
      severity: 0,
    },
  ]);
});
