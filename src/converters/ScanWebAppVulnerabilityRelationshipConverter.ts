import {
  SCAN_ENTITY_TYPE,
  SCAN_WEBAPP_VULNERABILITY_RELATIONSHIP_CLASS,
  SCAN_WEBAPP_VULNERABILITY_RELATIONSHIP_TYPE,
  ScanWebAppVulnerabilityRelationship,
  WEBAPP_VULNERABILITY_ENTITY_TYPE,
} from "../jupiterone/entities";
import { Dictionary, Scan, WebAppVulnerability } from "../tenable/types";
import {
  generateEntityKey,
  generateRelationshipKey,
} from "../utils/generateKey";

export function createScanWebAppVulnerabilityRelationships(
  scans: Scan[],
  webAppVulnerabilitiesDictionary: Dictionary<WebAppVulnerability[]>,
): ScanWebAppVulnerabilityRelationship[] {
  const defaultValue: ScanWebAppVulnerabilityRelationship[] = [];

  const vulnerabilityArrays: WebAppVulnerability[][] = Object.values(
    webAppVulnerabilitiesDictionary,
  );
  const vulnerabilityArray: WebAppVulnerability[] = vulnerabilityArrays.reduce(
    (acc, item) => acc.concat(item),
    [],
  );

  const relationships: ScanWebAppVulnerabilityRelationship[] = scans.reduce(
    (acc, scan) => {
      const vulnerabilities = vulnerabilityArray.filter(
        value => value.scan_id === scan.id,
      );

      const relationshipsForOneScan: ScanWebAppVulnerabilityRelationship[] = vulnerabilities.map(
        item => {
          const parentKey = generateEntityKey(SCAN_ENTITY_TYPE, scan.id);
          const childKey = generateEntityKey(
            WEBAPP_VULNERABILITY_ENTITY_TYPE,
            `${item.plugin_id}_${item.host_id}_${item.scan_id}`,
          );
          const relationKey = generateRelationshipKey(
            parentKey,
            SCAN_WEBAPP_VULNERABILITY_RELATIONSHIP_CLASS,
            childKey,
          );

          const relationship: ScanWebAppVulnerabilityRelationship = {
            _class: SCAN_WEBAPP_VULNERABILITY_RELATIONSHIP_CLASS,
            _type: SCAN_WEBAPP_VULNERABILITY_RELATIONSHIP_TYPE,
            _fromEntityKey: parentKey,
            _key: relationKey,
            _toEntityKey: childKey,
          };
          return relationship;
        },
      );

      return acc.concat(relationshipsForOneScan);
    },
    defaultValue,
  );

  return relationships;
}
