import { Dictionary } from "../tenable";
import { createApplicationVulnerabilityRelationships } from "./ApplicationVulnerabilityRelationshipConverter";

test("convert application vulnerability relationships", () => {
  const vulnerabilitiesDictionary: Dictionary<any[]> = {
    "dualbootpartners.com": [
      {
        host_id: 1,
        hostname: "dualbootpartners.com",
        plugin_id: 112526,
        plugin_name: "Missing 'X-XSS-Protection' Header",
        plugin_family: "Web Applications",
        count: 1,
        severity_index: 0,
        severity: 1,
      },
      {
        vuln_index: 1,
        host_id: 1,
        hostname: "dualbootpartners.com",
        plugin_id: 112530,
        plugin_name: "SSL/TLS Versions Supported",
        plugin_family: "Web Servers",
        count: 1,
        severity_index: 1,
        severity: 0,
      },
      {
        vuln_index: 2,
        host_id: 1,
        hostname: "dualbootpartners.com",
        plugin_id: 115491,
        plugin_name: "SSL/TLS Cipher Suites Supported",
        plugin_family: "Web Servers",
        count: 1,
        severity_index: 2,
        severity: 0,
      },
      {
        vuln_index: 3,
        host_id: 1,
        hostname: "dualbootpartners.com",
        plugin_id: 98138,
        plugin_name: "Screenshot",
        plugin_family: "General",
        count: 1,
        severity_index: 3,
        severity: 0,
      },
    ],
    "dualboot.ru": [
      {
        vuln_index: 0,
        host_id: 1,
        hostname: "dualboot.ru",
        plugin_id: 98138,
        plugin_name: "Screenshot",
        plugin_family: "General",
        count: 1,
        severity_index: 0,
        severity: 0,
      },
      {
        vuln_index: 1,
        host_id: 1,
        hostname: "dualboot.ru",
        plugin_id: 98000,
        plugin_name: "Scan Information",
        plugin_family: "General",
        count: 1,
        severity_index: 1,
        severity: 0,
      },
      {
        vuln_index: 2,
        host_id: 1,
        hostname: "dualboot.ru",
        plugin_id: 98050,
        plugin_name: "Interesting response",
        plugin_family: "Web Applications",
        count: 3,
        severity_index: 2,
        severity: 0,
      },
    ],
  };

  const assets: any[] = [
    {
      id: "df0f891f-f18b-4047-8fe1-6e15ca7798a8",
      has_agent: false,
      last_seen: "2019-04-15T12:16:15.622Z",
      sources: [
        {
          name: "WAS",
          first_seen: "2019-04-12T10:48:54.822Z",
          last_seen: "2019-04-12T10:48:54.822Z",
        },
        {
          name: "NESSUS_SCAN",
          first_seen: "2019-04-15T12:16:15.622Z",
          last_seen: "2019-04-15T12:16:15.622Z",
        },
      ],
      ipv4: ["185.203.72.17"],
      ipv6: [],
      fqdn: [
        "dualbootpartners.com",
        "dualbootpartnerscopy.com",
        "dualbootpartnerscopycopy.com",
      ],
      netbios_name: [],
      operating_system: [],
      agent_name: [],
      aws_ec2_name: [],
      mac_address: [],
    },
    {
      id: "5cf9ecff-6867-46df-bf8f-d819fc8ed0b0",
      has_agent: false,
      last_seen: "2019-04-15T12:16:15.622Z",
      sources: [
        {
          name: "WAS",
          first_seen: "2019-04-12T10:48:00.711Z",
          last_seen: "2019-04-12T10:48:00.711Z",
        },
        {
          name: "NESSUS_SCAN",
          first_seen: "2019-04-15T12:16:15.622Z",
          last_seen: "2019-04-15T12:16:15.622Z",
        },
      ],
      ipv4: ["18.221.79.150"],
      ipv6: [],
      fqdn: ["dualboot.ru"],
      netbios_name: [],
      operating_system: [
        "Linux Kernel 2.2",
        "Linux Kernel 2.4",
        "Linux Kernel 2.6",
      ],
      agent_name: [],
      aws_ec2_name: [],
      mac_address: [],
    },
  ];

  const relationships = createApplicationVulnerabilityRelationships(
    assets,
    vulnerabilitiesDictionary,
  );

  expect(relationships).toEqual([
    {
      _class: "HAS",
      _fromEntityKey: "tenable_asset_df0f891f-f18b-4047-8fe1-6e15ca7798a8",
      _key:
        "tenable_asset_df0f891f-f18b-4047-8fe1-6e15ca7798a8_has_tenable_vulnerability_112526",
      _toEntityKey: "tenable_vulnerability_112526",
      _type: "tenable_asset_has_tenable_vulnerability",
    },
    {
      _class: "HAS",
      _fromEntityKey: "tenable_asset_df0f891f-f18b-4047-8fe1-6e15ca7798a8",
      _key:
        "tenable_asset_df0f891f-f18b-4047-8fe1-6e15ca7798a8_has_tenable_vulnerability_112530",
      _toEntityKey: "tenable_vulnerability_112530",
      _type: "tenable_asset_has_tenable_vulnerability",
    },
    {
      _class: "HAS",
      _fromEntityKey: "tenable_asset_df0f891f-f18b-4047-8fe1-6e15ca7798a8",
      _key:
        "tenable_asset_df0f891f-f18b-4047-8fe1-6e15ca7798a8_has_tenable_vulnerability_115491",
      _toEntityKey: "tenable_vulnerability_115491",
      _type: "tenable_asset_has_tenable_vulnerability",
    },
    {
      _class: "HAS",
      _fromEntityKey: "tenable_asset_df0f891f-f18b-4047-8fe1-6e15ca7798a8",
      _key:
        "tenable_asset_df0f891f-f18b-4047-8fe1-6e15ca7798a8_has_tenable_vulnerability_98138",
      _toEntityKey: "tenable_vulnerability_98138",
      _type: "tenable_asset_has_tenable_vulnerability",
    },
    {
      _class: "HAS",
      _fromEntityKey: "tenable_asset_5cf9ecff-6867-46df-bf8f-d819fc8ed0b0",
      _key:
        "tenable_asset_5cf9ecff-6867-46df-bf8f-d819fc8ed0b0_has_tenable_vulnerability_98138",
      _toEntityKey: "tenable_vulnerability_98138",
      _type: "tenable_asset_has_tenable_vulnerability",
    },
    {
      _class: "HAS",
      _fromEntityKey: "tenable_asset_5cf9ecff-6867-46df-bf8f-d819fc8ed0b0",
      _key:
        "tenable_asset_5cf9ecff-6867-46df-bf8f-d819fc8ed0b0_has_tenable_vulnerability_98000",
      _toEntityKey: "tenable_vulnerability_98000",
      _type: "tenable_asset_has_tenable_vulnerability",
    },
    {
      _class: "HAS",
      _fromEntityKey: "tenable_asset_5cf9ecff-6867-46df-bf8f-d819fc8ed0b0",
      _key:
        "tenable_asset_5cf9ecff-6867-46df-bf8f-d819fc8ed0b0_has_tenable_vulnerability_98050",
      _toEntityKey: "tenable_vulnerability_98050",
      _type: "tenable_asset_has_tenable_vulnerability",
    },
  ]);
});
