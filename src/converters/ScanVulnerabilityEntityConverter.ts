import {
  TENABLE_VULNERABILITY_ENTITY_CLASS,
  TENABLE_VULNERABILITY_ENTITY_TYPE,
  TenableVulnerabilityEntity,
} from "../jupiterone/entities";
import { Dictionary, ScanVulnerability } from "../tenable/types";
import { generateEntityKey } from "../utils/generateKey";

export function createVulnerabilityEntities(
  vulnerabilities: Dictionary<ScanVulnerability[]>,
): TenableVulnerabilityEntity[] {
  return Object.values(vulnerabilities).reduce(
    (acc: TenableVulnerabilityEntity[], data: ScanVulnerability[]) => {
      return [...acc, ...data.map(mapToVulnerabilityEntity)];
    },
    [],
  );
}

function mapToVulnerabilityEntity(
  item: ScanVulnerability,
): TenableVulnerabilityEntity {
  return {
    _key: generateEntityKey(TENABLE_VULNERABILITY_ENTITY_TYPE, item.plugin_id),
    _type: TENABLE_VULNERABILITY_ENTITY_TYPE,
    _class: TENABLE_VULNERABILITY_ENTITY_CLASS,
    pluginId: item.plugin_id,
    pluginFamily: item.plugin_family,
    pluginName: item.plugin_name,
    severity: item.severity,
  };
}
